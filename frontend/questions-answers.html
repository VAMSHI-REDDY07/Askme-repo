<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/profile.css">
  <title>AskMe - Questions and Answers</title>
  <style>
    /* Basic reset and fonts */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f9f9f9;
    }
     /* Navigation Bar at Top */
  .navbar {
    position: fixed;
    top: 0;
    width: 100%;
    background-color: #007bff;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    z-index: 1000;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .logo {
    margin-left: 30px;
    font-size: 24px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .nav-links {
    list-style: none;
    display: flex;
    gap: 20px;
    margin-left: 40px;
    padding-left: 20px;
  }
  
  .nav-links li a {
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-right: 20px;
    padding-left: 20px;
  }
  
  .nav-links li a:hover {
    text-decoration: underline;
  }
    /* Fixed search bar */
    #search-section {
      padding: 20px;
      background: #ffffff;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-top: 100px;
      display: flex;
    }

    #searchInput {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      min-width: 200px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    #searchInput:focus {
      border-color: #007bff;
      outline: none;
    }

    #search-section button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: auto;
    }

    #search-section button:hover {
      background-color: #0056b3;
    }

    /* Container for Q&A below fixed search bar */
    #qa-section {
      margin-top: 20px; /* enough space below fixed search */
      max-height: calc(100vh - 90px);
      overflow-y: auto;
      padding: 0 20px 20px 20px;
    }

    .question {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }

    .question p {
      margin: 8px 0;
    }

    .answer {
      background: #f1f1f1;
      margin: 8px 0 8px 20px;
      padding: 10px;
      border-radius: 6px;
    }

    .answer-author {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
      font-style: italic;
    }

    .qa-actions {
      margin-top: 8px;
      display: flex;
      gap: 10px;
    }

    .qa-actions button {
      cursor: pointer;
      padding: 5px 12px;
      border: 1px solid #007bff;
      border-radius: 5px;
      background: white;
      color: #007bff;
      font-size: 14px;
      transition: background-color 0.3s, color 0.3s;
    }

    .qa-actions button:hover {
      background-color: #007bff;
      color: white;
    }

    .profile-circle {
      margin-right: 20px;
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .profile-circle:hover {
      transform: scale(1.05);
    }

    .profile-menu {
      background-color: white;
      border: none;
      position: absolute;
      top: 60px;
      right: 0;
      padding: 15px;
      border-radius: 8px;
      margin-right: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      z-index: 1000;
    }

    .profile-menu button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }

    .profile-menu button:hover {
      background-color: #0056b3;
    }

    /* Style for action buttons */
    .qa-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }

    .qa-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }

    .qa-actions button:first-child {
      background-color: #007bff;
      color: white;
    }

    .qa-actions button:first-child:hover {
      background-color: #0056b3;
    }

    .qa-actions button:last-child {
      background-color: #28a745;
      color: white;
    }

    .qa-actions button:last-child:hover {
      background-color: #218838;
    }

  </style>
</head>
<body>
  
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="logo">
      <a href="index.html">
        <img src="logo.jpg" alt="AskMe Logo" style="height:40px;width:auto;margin-right:10px;vertical-align:middle;" />
      </a>
      <div id="welcomeMessage"></div>
    </div>
    <ul class="nav-links">
      <!-- <li><a href="questions-answers.html">Visit the Q&A Portal</a></li> -->
      <li><a href="#" onclick="checkLoginBeforeAdd()">Add a new Question</a></li>
      <li><a href="#">Tags</a></li>
      <li><a href="index.html">Home</a></li>
      <li id="login-signup-links">
        <a href="login.html" id="loginLink">Login</a>  
        <a href="signup.html" id="signupLink">Sign Up</a>
      </li>
      <li id="profile-icon" style="display: none;">
        <div class="profile-circle" id="profileCircle" onclick="toggleProfileMenu()"></div>
        <div id="profileMenu" class="profile-menu" style="display: none;">
          <p id="profileUsername"></p>
          <button onclick="logout()">Log Out</button>
        </div>
      </li>
    </ul>
  </nav>

  <main>
    <!-- 🔍 Search Section -->
    <section id="search-section">
      <input type="text" id="searchInput" placeholder="What do you want to know ?" />
      <button onclick="searchQuestion()">Search</button>
    </section>
  </main>

  <!-- Q&A container -->
  <section id="qa-section"></section>

  <!-- Answer Modal -->
  <div id="answerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px; margin: 100px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <h3>Submit Answer</h3>
      <form id="answerForm">
        <input type="hidden" id="modalQuestionId">
        <textarea id="modalAnswerText" style="width: 100%; min-height: 100px; margin: 10px 0; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Type your answer here..." required></textarea>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" id="closeModal" style="background: #ccc;">Cancel</button>
          <button type="submit" style="background: #007bff; color: white;">Submit Answer</button>
        </div>
      </form>
    </div>
  </div>

  <script>

    // On page load, fetch and show questions with answers
   window.onload = function() {
      // Get search parameter from URL if it exists
      const urlParams = new URLSearchParams(window.location.search);
      const searchQuery = urlParams.get('search');
      
      // If there's a search query, put it in the search input
      if (searchQuery) {
        document.getElementById("searchInput").value = searchQuery;
        loadQuestions(searchQuery);
      } else {
        loadQuestions();
      }

      // Handle user authentication display
      const isLoggedIn = localStorage.getItem('isLoggedIn');
      const loginSignupLinks = document.getElementById('login-signup-links');
      const profileIcon = document.getElementById('profile-icon');
      const profileCircle = document.getElementById('profileCircle');
      const profileUsername = document.getElementById('profileUsername');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const username = localStorage.getItem('username');

      if (isLoggedIn === 'true' && username) {
        loginSignupLinks.style.display = 'none';
        profileIcon.style.display = 'inline-block';
        profileCircle.textContent = username.charAt(0).toUpperCase();
        profileUsername.textContent = username;
        welcomeMessage.textContent = `Welcome back, ${username}!`;
      } else {
        loginSignupLinks.style.display = 'inline-block';
        profileIcon.style.display = 'none';
      }
    };

    function toggleProfileMenu() {
      const profileMenu = document.getElementById('profileMenu');
      profileMenu.style.display = (profileMenu.style.display === 'none' || profileMenu.style.display === '') ? 'block' : 'none';
    }

    function logout() {
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('username');
      document.getElementById('profile-icon').style.display = 'none';
      document.getElementById('login-signup-links').style.display = 'inline-block';
      window.location.href = 'landing.html';
    }
    // Load all questions and answers from backend
    async function loadQuestions(query = "") {
      try {
        let url;
        if (query) {
          // Use Node.js questions endpoint with search parameter
          url = `http://localhost:3000/questions?search=${encodeURIComponent(query)}`;
        } else {
          // Use regular Node.js endpoint for listing all questions
          url = "http://localhost:3000/questions";
        }

        const res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch questions");
        const questions = await res.json();

        const qaSection = document.getElementById("qa-section");
        qaSection.innerHTML = "";

        if (questions.length === 0) {
          qaSection.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
              <h3 style="color: #2c3e50; margin-bottom: 20px;">${query ? `No questions found matching "${query}"` : "No questions found."}</h3>
              <p style="color: #666; margin-bottom: 25px;">Would you like to be the first to ask a question?</p>
              <div style="margin-bottom: 20px;">
                <p style="color: #666; font-size: 0.9em;">Here is a suggestion:</p>
                
              </div>
              <button onclick="checkLoginBeforeAdd()" style="
                padding: 12px 25px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 1rem;
                transition: all 0.3s ease;
              ">Add New Question</button>
            </div>`;
          return;
        }

        // If there was a search, show the results count
        if (query) {
          const resultsHeader = document.createElement("div");
          resultsHeader.style.padding = "10px 0";
          resultsHeader.innerHTML = `<h3>Found ${questions.length} question${questions.length === 1 ? '' : 's'} matching "${query}"</h3>`;
          qaSection.appendChild(resultsHeader);
        }

        questions.forEach(async q => {
          const qDiv = document.createElement("div");
          qDiv.className = "question";

          // Question text
          const qText = document.createElement("p");
          qText.innerHTML = `<strong>Q:</strong> ${q.question_text}`;
          qDiv.appendChild(qText);

          // Fetch answers for this question
          try {
            const answerRes = await fetch(`http://localhost:3000/questions/${q.id}`);
            if (!answerRes.ok) throw new Error("Failed to fetch answers");
            const questionData = await answerRes.json();
            
            if (questionData.answers && questionData.answers.length > 0) {
              questionData.answers.forEach(a => {
                const aDiv = document.createElement("div");
                aDiv.className = "answer";
                aDiv.innerHTML = `
                  <strong>A:</strong> ${a.answer_text}
                `;
                qDiv.appendChild(aDiv);
              });
            } else {
              const noAns = document.createElement("p");
              noAns.style.marginLeft = "20px";
              noAns.textContent = "No answers yet.";
              qDiv.appendChild(noAns);
            }
          } catch (error) {
            console.error("Error fetching answers:", error);
            const errorDiv = document.createElement("p");
            errorDiv.style.marginLeft = "20px";
            errorDiv.style.color = "red";
            errorDiv.textContent = "Error loading answers.";
            qDiv.appendChild(errorDiv);
          }

          // Add Answer button for question
          const qActions = document.createElement("div");
          qActions.className = "qa-actions";

          const addAnswerBtn = document.createElement("button");
          addAnswerBtn.textContent = "Add Answer";
          addAnswerBtn.onclick = () => openAnswerModal(q.id);
          qActions.appendChild(addAnswerBtn);

          // Add Copy Link button
          const copyLinkBtn = document.createElement("button");
          copyLinkBtn.textContent = "Copy Link";
          copyLinkBtn.onclick = () => copyQuestionLink(q.id, q.question_text);
          qActions.appendChild(copyLinkBtn);

          qDiv.appendChild(qActions);

          qaSection.appendChild(qDiv);
        });

      } catch (error) {
        console.error(error);
        document.getElementById("qa-section").innerHTML = `
          <div style="color: red; padding: 20px;">
            Error loading questions. Please try again later.
            <br>
            <small>${error.message}</small>
          </div>
        `;
      }
    }
    // Check if user is logged in before allowing to add a question
    function checkLoginBeforeAdd() {
      const isLoggedIn = localStorage.getItem('isLoggedIn');
      if (isLoggedIn === 'true') {
        window.location.href = 'add-new-question.html'; // Redirect to add question page
      } else {
        alert("Please log in to add a question.");
        window.location.href = 'login.html'; // Redirect to login page
      }
    }
    // Search question handler
    function searchQuestion() {
      const query = document.getElementById("searchInput").value.trim();
      if (!query) {
        loadQuestions(); // If empty query, load all questions
        return;
      }
      loadQuestions(query);
    }

    // Add event listener for Enter key in search input
    document.getElementById("searchInput").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        searchQuestion();
      }
    });

// Open modal
function openAnswerModal(questionId) {
  document.getElementById('modalQuestionId').value = questionId;
  document.getElementById('modalAnswerText').value = "";
  document.getElementById('answerModal').style.display = 'block';
}

// Close modal
document.getElementById('closeModal').onclick = function () {
  document.getElementById('answerModal').style.display = 'none';
};

// Copy question link function
function copyQuestionLink(questionId, questionText) {
  const currentUrl = window.location.origin + window.location.pathname;
  const questionUrl = `${currentUrl}?question=${questionId}`;
  
  // Create a temporary textarea to copy the text
  const textarea = document.createElement('textarea');
  textarea.value = questionUrl;
  document.body.appendChild(textarea);
  textarea.select();
  
  try {
    document.execCommand('copy');
    // Show success message
    const originalText = event.target.textContent;
    event.target.textContent = 'Copied!';
    event.target.style.backgroundColor = '#6c757d';
    
    setTimeout(() => {
      event.target.textContent = originalText;
      event.target.style.backgroundColor = '#28a745';
    }, 2000);
  } catch (err) {
    console.error('Failed to copy link:', err);
    alert('Failed to copy link. Please copy manually: ' + questionUrl);
  }
  
  document.body.removeChild(textarea);
}

// Submit answer form
document.getElementById('answerForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const questionId = document.getElementById('modalQuestionId').value;
  const answerText = document.getElementById('modalAnswerText').value;
  const username = localStorage.getItem('username') || 'Anonymous';

  const res = await fetch('http://localhost:3000/answers', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      question_id: questionId, 
      answer_text: answerText,
      username: username 
    })
  });   

  const result = await res.json();
  if (result.success) {
    alert('Answer added successfully');
    document.getElementById('answerModal').style.display = 'none';
    location.reload();
  } else {
    alert('Failed to add answer');
  }
});

  </script>

</body>
</html>
